
@model ElektronikSatisProje.Models.Profil
@{
    ViewBag.Title = "Siparişi Tamamla";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1 class="h3 mb-4 text-gray-800">Ödeme ve Onay</h1>

<div class="row">

    <!-- SOL KOLON: Adres ve Ödeme -->
    <div class="col-lg-8">

        <!-- 1. ADRES BİLGİLERİ -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Teslimat Adresi</h6>
            </div>
            <div class="card-body">
                @if (Model.Adresler != null && Model.Adresler.Count > 0)
                {
                    <form id="adresSecimForm">
                        @foreach (var adres in Model.Adresler)
                        {
                            <div class="custom-control custom-radio mb-3 border p-3 rounded">
                                <!-- Radio button value olarak adresin tam metnini tutsun -->
                                <input type="radio" id="adres_@adres.Baslik" name="SecilenAdres" class="custom-control-input"
                                       value="@adres.Baslik: @adres.AcikAdres / @adres.Ilce / @adres.Sehir" checked>
                                <label class="custom-control-label w-100" for="adres_@adres.Baslik">
                                    <span class="font-weight-bold text-primary">@adres.Baslik</span>
                                    <br>
                                    <span class="text-muted small">@adres.AcikAdres - @adres.Ilce / @adres.Sehir</span>
                                </label>
                            </div>
                        }
                    </form>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Kayıtlı adresiniz yok.
                        <a href="~/Home/Profil" class="font-weight-bold">Lütfen profilinizden adres ekleyin.</a>
                    </div>
                }
            </div>
        </div>

        <!-- 2. KREDİ KARTI BİLGİLERİ -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Kart Bilgileri</h6>
            </div>
            <div class="card-body">
                <form id="paymentForm">

                    <!-- Kart Sahibi -->
                    <div class="form-group position-relative">
                        <label>Kart Üzerindeki İsim</label>
                        <input type="text" class="form-control card-input" id="cardName" placeholder="Ad Soyad" onkeyup="validatePayment()">
                        <i class="fas fa-check-circle text-success validation-icon" id="icon-name"></i>
                    </div>

                    <!-- Kart Numarası -->
                    <div class="form-group position-relative">
                        <label>Kart Numarası (16 Hane)</label>
                        <input type="text" class="form-control card-input" id="cardNumber" placeholder="0000 0000 0000 0000" maxlength="19" onkeyup="formatCardNumber(this); validatePayment()">
                        <i class="fas fa-check-circle text-success validation-icon" id="icon-number"></i>
                    </div>

                    <div class="form-row">
                        <!-- Son Kullanma Tarihi -->
                        <div class="form-group col-md-6 position-relative">
                            <label>Son Kul. Tarihi (AA/YY)</label>
                            <input type="text" class="form-control card-input" id="cardDate" placeholder="MM/YY" maxlength="5" onkeyup="formatDate(this); validatePayment()">
                            <i class="fas fa-check-circle text-success validation-icon" id="icon-date"></i>
                        </div>

                        <!-- CVV -->
                        <div class="form-group col-md-6 position-relative">
                            <label>CVV (3 Hane)</label>
                            <input type="text" class="form-control card-input" id="cardCvv" placeholder="123" maxlength="3" onkeyup="validatePayment()">
                            <i class="fas fa-check-circle text-success validation-icon" id="icon-cvv"></i>
                        </div>
                    </div>

                </form>
            </div>
        </div>

    </div>

    <!-- SAĞ KOLON: Özet ve Buton -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Sipariş Özeti</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span>Toplam Tutar:</span>
                    <span class="font-weight-bold" id="checkoutTotal">0 TL</span>
                </div>
                <div class="alert alert-warning small">
                    <i class="fas fa-info-circle"></i> Ödeme butonunun aktif olması için kart bilgilerini eksiksiz giriniz.
                </div>

                <!-- SİPARİŞİ TAMAMLA BUTONU (Başlangıçta Disabled) -->
                <button id="btnCompleteOrder" class="btn btn-success btn-block btn-lg" disabled onclick="completeOrder()">
                    <i class="fas fa-lock"></i> Siparişi Tamamla
                </button>
            </div>
        </div>
    </div>

</div>

<!-- BAŞARI MESAJI (Overlay - Gizli) -->
<div id="successOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; flex-direction:column;">
    <div class="text-center">
        <i class="fas fa-check-circle text-success" style="font-size: 100px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);"></i>
        <h2 class="text-white mt-4 font-weight-bold">Siparişiniz Başarıyla Alındı!</h2>
        <p class="text-white-50">Geçmiş siparişlerim sayfasına yönlendiriliyorsunuz...</p>
    </div>
</div>

<!-- CSS -->
<style>
    .validation-icon {
        position: absolute;
        right: 15px;
        top: 45px; /* Inputun içine denk getirmek için */
        font-size: 1.2rem;
        display: none; /* Başlangıçta gizli */
    }

    @@keyframes popIn {
        0% {
            transform: scale(0);
            opacity: 0;
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>

<!-- JAVASCRIPT -->
<script>
    // --- 1. KİŞİYE ÖZEL ANAHTARLAR (YENİ EKLENEN KISIM) ---
    // Giriş yapan kullanıcının adını alıyoruz
    var activeUser = '@User.Identity.Name';

    // Eğer kullanıcı yoksa boş gelebilir, güvenli olsun diye kontrol edelim
    // Ama Sepet logic'inde zaten giriş zorunlu kılmıştık.

    // Anahtarları oluşturuyoruz: 'cart_Ali', 'cart_Doruk' gibi...
    var cartKey = 'cart_' + activeUser;
    var orderKey = 'orders_' + activeUser;
    // ------------------------------------------------------

    // Sayfa açılınca tutarı göster
    document.addEventListener("DOMContentLoaded", function() {
        calculateTotal();
    });

    function calculateTotal() {
        // ARTIK DİNAMİK KEY KULLANIYORUZ
        var cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        var total = 0;

        cart.forEach(item => total += item.price * item.quantity);

        // Eğer element varsa yazdır (Hata almamak için kontrol)
        var totalLabel = document.getElementById('checkoutTotal');
        if(totalLabel) totalLabel.innerText = formatMoney(total) + " TL";
    }

    // --- 2. KART GİRİŞ FORMATLARI (GÖRSEL DÜZENLEMELER) ---
    function formatCardNumber(input) {
        // Boşlukları sil, 4'lü gruplara ayır
        let val = input.value.replace(/\D/g, '');
        let newVal = '';
        for(let i=0; i<val.length; i++) {
            if(i > 0 && i%4 == 0) newVal += ' ';
            newVal += val[i];
        }
        input.value = newVal;
    }

    function formatDate(input) {
        // MM/YY formatı
        let val = input.value.replace(/\D/g, '');
        if(val.length > 2) {
            input.value = val.substring(0,2) + '/' + val.substring(2,4);
        } else {
            input.value = val;
        }
    }

    // --- 3. DOĞRULAMA (Yeşil Tikler & Buton Aktifliği) ---
    function validatePayment() {
        let isValid = true;

        // İsim Kontrolü (En az 3 harf)
        if(document.getElementById('cardName').value.length > 3) {
            document.getElementById('icon-name').style.display = 'block';
        } else {
            document.getElementById('icon-name').style.display = 'none';
            isValid = false;
        }

        // Kart No Kontrolü (16 hane + 3 boşluk = 19 karakter)
        if(document.getElementById('cardNumber').value.length === 19) {
            document.getElementById('icon-number').style.display = 'block';
        } else {
            document.getElementById('icon-number').style.display = 'none';
            isValid = false;
        }

        // Tarih Kontrolü (5 karakter)
        if(document.getElementById('cardDate').value.length === 5) {
            document.getElementById('icon-date').style.display = 'block';
        } else {
            document.getElementById('icon-date').style.display = 'none';
            isValid = false;
        }

        // CVV Kontrolü (3 hane)
        if(document.getElementById('cardCvv').value.length === 3) {
            document.getElementById('icon-cvv').style.display = 'block';
        } else {
            document.getElementById('icon-cvv').style.display = 'none';
            isValid = false;
        }

        // Buton Durumu
        document.getElementById('btnCompleteOrder').disabled = !isValid;
    }

    // --- 4. SİPARİŞİ TAMAMLAMA VE KAYDETME (GÜNCELLENEN KISIM) ---
   // --- 4. SİPARİŞİ TAMAMLAMA (ADRES SEÇİMLİ FİNAL VERSİYON) ---
    function completeOrder() {
        // 1. Sepeti Al
        var cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        if (cart.length === 0) return;

        // --- YENİ EKLENEN KISIM: ADRES KONTROLÜ ---
        // Radio buttonlardan hangisi seçiliyse onun değerini al
        var secilenAdres = $("input[name='SecilenAdres']:checked").val();

        // Eğer hiçbir şey seçilmemişse uyarı ver ve işlemi durdur
        if (!secilenAdres) {
            // SweetAlert varsa onu kullan, yoksa normal alert
            if(typeof Swal !== 'undefined'){
                Swal.fire('Eksik Bilgi', 'Lütfen bir teslimat adresi seçiniz (veya Profil sayfasından ekleyiniz).', 'warning');
            } else {
                alert("Lütfen bir teslimat adresi seçiniz.");
            }
            return; // Fonksiyonu burada keser, aşağıya inmez
        }
        // -------------------------------------------

        var totalText = document.getElementById('checkoutTotal').innerText;

        // 2. Sipariş Nesnesini Hazırla
        var orderData = {
            SiparisNo: Math.floor(Math.random() * 1000000).toString(),
            Tarih: new Date().toLocaleString(),
            ToplamTutar: totalText,
            Durum: "Hazırlanıyor",
            TeslimatAdresi: secilenAdres, // <-- ADRESİ BURAYA EKLİYORUZ
            Urunler: []
        };

        // Sepetteki ürünleri backend formatına çevir
        cart.forEach(function(item) {
            orderData.Urunler.push({
                UrunAdi: item.name,
                Resim: item.image,
                Fiyat: item.price,
                Adet: item.quantity
            });
        });

        // 3. AJAX ile Sunucuya Gönder
        $.ajax({
            url: '@Url.Action("SiparisKaydet", "Home")',
            type: 'POST',
            data: orderData,
            success: function(response) {
                if (response.success) {
                    // Başarılıysa Sepeti Temizle
                    localStorage.removeItem(cartKey);
                    if (window.calculateCartTotal) window.calculateCartTotal();

                    // Animasyonu Göster
                    var overlay = document.getElementById('successOverlay');
                    if(overlay) overlay.style.display = 'flex';

                    // 2 Saniye Sonra Yönlendir
                    setTimeout(function() {
                        window.location.href = '@Url.Action("Gecmis_Siparislerim", "Home")';
                    }, 2000);
                } else {
                    alert("Sipariş kaydedilirken hata oluştu.");
                }
            },
            error: function() {
                alert("Sunucu hatası.");
            }
        });
    }

    function formatMoney(amount) {
        return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
</script>

