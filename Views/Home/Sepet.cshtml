
@{
    ViewBag.Title = "Sepetim";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Başlık -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Alışveriş Sepetim</h1>

    <!-- Sepeti Temizle Butonu -->
    <button onclick="clearCart()" class="d-none d-sm-inline-block btn btn-sm btn-danger shadow-sm">
        <i class="fas fa-trash fa-sm text-white-50"></i> Sepeti Boşalt
    </button>
</div>

<div class="row">
    <!-- Sepet Tablosu -->
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Sepetteki Ürünler</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr class="bg-light">
                                <th style="width: 100px;">Ürün</th>
                                <th>Ürün Adı</th>
                                <th>Fiyat</th>
                                <th>Adet</th>
                                <th>Toplam</th>
                                <th style="width: 50px;">İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="cartTableBody">
                            <!-- JAVASCRIPT BURAYI DOLDURACAK -->
                        </tbody>
                    </table>
                </div>

                <!-- Sepet Boş Uyarısı (Varsayılan gizli) -->
                <div id="emptyCartMessage" class="text-center py-5" style="display:none;">
                    <i class="fas fa-shopping-basket fa-3x text-gray-300 mb-3"></i>
                    <p class="lead text-gray-800">Sepetinizde henüz ürün yok.</p>
                    <a href="~/Home/Bilgisayarlar" class="btn btn-primary">Alışverişe Başla</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sipariş Özeti -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Sipariş Özeti</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <span>Ara Toplam:</span>
                    <span id="subTotal" class="font-weight-bold">0 TL</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Kargo:</span>
                    <span class="text-success">Bedava</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-4">
                    <span class="h5 font-weight-bold">Genel Toplam:</span>
                    <span id="grandTotal" class="h5 font-weight-bold text-primary">0 TL</span>
                </div>
                <a href="@Url.Action("SiparisiTamamla", "Home")" class="btn btn-success btn-block btn-lg">
                    <i class="fas fa-check"></i> Siparişi Tamamla
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Sepette, kişiye özel siparişleri tutan script -->
<script>
    // --- KİŞİYE ÖZEL ANAHTAR TANIMI ---
    var activeUser = '@User.Identity.Name';
    var cartKey = 'cart_' + activeUser;
    // ----------------------------------

    document.addEventListener("DOMContentLoaded", function () {
        renderCartPage();
    });

    function renderCartPage() {
        // ARTIK DİNAMİK ANAHTARDAN OKUYORUZ
        var cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        var tableBody = document.getElementById('cartTableBody');

        tableBody.innerHTML = "";
        var totalPrice = 0;

        if (cart.length === 0) {
            document.getElementById('emptyCartMessage').style.display = 'block';
            document.querySelector('.table-responsive').style.display = 'none';
            updateTotals(0);
            return;
        }

        document.getElementById('emptyCartMessage').style.display = 'none';
        document.querySelector('.table-responsive').style.display = 'block';

        cart.forEach(function (item, index) {
            var rowTotal = item.price * item.quantity;
            totalPrice += rowTotal;

            var imgPath = item.image ? item.image : '/Content/image/sembol_sepet.png';

            var row = `
                <tr class="bg-white text-dark">
                    <td class="text-center">
                        <img src="${imgPath}" style="width: 60px; height: 60px; object-fit: contain; border: 1px solid #ddd; border-radius: 5px;">
                    </td>
                    <td class="align-middle font-weight-bold">${item.name}</td>
                    <td class="align-middle">${formatMoney(item.price)} TL</td>
                    <td class="align-middle">
                        <div class="input-group input-group-sm" style="width: 100px; margin: 0 auto;">
                            <div class="input-group-prepend">
                                <button class="btn btn-outline-secondary" onclick="changeQty(${index}, -1)">-</button>
                            </div>
                            <input type="text" class="form-control text-center" value="${item.quantity}" readonly>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" onclick="changeQty(${index}, 1)">+</button>
                            </div>
                        </div>
                    </td>
                    <td class="align-middle font-weight-bold text-primary">${formatMoney(rowTotal)} TL</td>
                    <td class="align-middle text-center">
                        <button class="btn btn-danger btn-circle btn-sm" onclick="removeItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });

        updateTotals(totalPrice);
    }

    function changeQty(index, change) {
        var cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        cart[index].quantity += change;
        if (cart[index].quantity <= 0) cart.splice(index, 1);

        // GÜNCEL HALİNİ KİŞİYE ÖZEL KAYDET
        localStorage.setItem(cartKey, JSON.stringify(cart));

        renderCartPage();
        if (window.calculateCartTotal) window.calculateCartTotal();
    }

    function removeItem(index) {
        var cart = JSON.parse(localStorage.getItem(cartKey)) || [];
        cart.splice(index, 1);

        // SİLİNCE DE KİŞİYE ÖZEL KAYDET
        localStorage.setItem(cartKey, JSON.stringify(cart));

        renderCartPage();
        if (window.calculateCartTotal) window.calculateCartTotal();
    }

    function clearCart() {
        if (confirm("Sepet temizlensin mi?")) {
            localStorage.removeItem(cartKey); // SADECE KENDİ SEPETİNİ SİL
            renderCartPage();
            if (window.calculateCartTotal) window.calculateCartTotal();
        }
    }

    function updateTotals(total) {
        document.getElementById('subTotal').innerText = formatMoney(total) + " TL";
        document.getElementById('grandTotal').innerText = formatMoney(total) + " TL";
    }

    function formatMoney(amount) {
        return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
</script>

