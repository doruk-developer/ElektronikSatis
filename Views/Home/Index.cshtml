@model IEnumerable<ElektronikSatis.Models.Urun>

@{
    ViewBag.Title = "Anasayfa";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- 1. BÖLÜM: SLIDER -->
<div id="kampanyaCarousel" class="carousel slide mb-5 shadow-lg rounded overflow-hidden" data-ride="carousel">
    <ol class="carousel-indicators">
        <li data-target="#kampanyaCarousel" data-slide-to="0" class="active"></li>
        <li data-target="#kampanyaCarousel" data-slide-to="1"></li>
        <li data-target="#kampanyaCarousel" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner">
        <div class="carousel-item active" style="height: 350px; background: linear-gradient(45deg, #4e73df, #224abe);">
            <div class="d-flex h-100 align-items-center justify-content-center text-white flex-column">
                <h1 class="display-4 font-weight-bold">EFSANE İNDİRİMLER</h1>
                <p class="lead">Teknolojide fırsat günleri başladı.</p>
                <a href="#urunListesiBolumu" class="btn btn-light btn-lg font-weight-bold text-primary mt-3">Alışverişe Başla</a>
            </div>
        </div>
        <div class="carousel-item" style="height: 350px; background: linear-gradient(45deg, #1cc88a, #13855c);">
            <div class="d-flex h-100 align-items-center justify-content-center text-white flex-column">
                <h1 class="display-4 font-weight-bold">YENİ NESİL TELEFONLAR</h1>
                <p class="lead">Dünyayla bağlantınızı koparmayın.</p>
            </div>
        </div>
        <div class="carousel-item" style="height: 350px; background: linear-gradient(45deg, #36b9cc, #258391);">
            <div class="d-flex h-100 align-items-center justify-content-center text-white flex-column">
                <h1 class="display-4 font-weight-bold">ENDÜSTRİYEL ÇÖZÜMLER</h1>
                <p class="lead">İş yeriniz için profesyonel altyapı.</p>
            </div>
        </div>
    </div>
    <a class="carousel-control-prev" href="#kampanyaCarousel" role="button" data-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    </a>
    <a class="carousel-control-next" href="#kampanyaCarousel" role="button" data-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
    </a>
</div>

<!-- 2. BÖLÜM: FİLTRE VE ÜRÜNLER -->
<div class="row" id="urunListesiBolumu">

    <!-- SOL KOLON: FİLTRE PANELİ -->
    <div class="col-lg-3 mb-4">
        <div class="card shadow-sm border-0 sticky-top" style="top: 100px; z-index: 1;">
            <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                <h5 class="font-weight-bold text-gray-800"><i class="fas fa-filter mr-2 text-primary"></i> Filtrele</h5>
            </div>
            <div class="card-body">

                <!-- Kategori Filtresi -->
                <h6 class="font-weight-bold text-dark mt-2">Kategoriler</h6>

                <!-- Tümünü Seç -->
                <div class="custom-control custom-checkbox mb-2 pb-2 border-bottom">
                    <input type="checkbox" class="custom-control-input" id="checkAll" checked onchange="toggleAllCategories(this)">
                    <label class="custom-control-label font-weight-bold text-primary" for="checkAll">Tüm Ürünler</label>
                </div>

                <div class="custom-control custom-checkbox mb-2 mt-2">
                    <input type="checkbox" class="custom-control-input filter-check" id="cat1" value="Bilgisayar" checked>
                    <label class="custom-control-label" for="cat1">Bilgisayarlar</label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input filter-check" id="cat2" value="Telefon" checked>
                    <label class="custom-control-label" for="cat2">Telefonlar</label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input filter-check" id="cat3" value="Switch" checked>
                    <label class="custom-control-label" for="cat3">Switchler</label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input filter-check" id="cat4" value="Router" checked>
                    <label class="custom-control-label" for="cat4">Routerlar</label>
                </div>

                <hr>

                <!-- Fiyat Filtresi -->
                <h6 class="font-weight-bold text-dark">Fiyat Aralığı</h6>
                <div class="form-group">
                    <label class="small text-muted mb-1">Maksimum Bütçe:</label>

                    <!-- Input ve Onay Butonu -->
                    <div class="input-group mb-2">
                        <input type="number" id="priceInput" class="form-control form-control-sm font-weight-bold text-primary"
                               value="50000" min="0" step="100" placeholder="Tutar girin">
                        <div class="input-group-append">
                            <button class="btn btn-sm btn-primary" type="button" onclick="manualPriceUpdate()">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Kaydırma Çubuğu -->
                    <!-- oninput="sliderMoved()": Sadece çubukla oynayınca çalışır -->
                    <input type="range" class="custom-range" id="priceRange" min="0" max="50000" step="500" value="50000" oninput="sliderMoved()">

                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">0 TL</small>
                        <!-- Sağ Tavan Fiyatı (Dinamik) -->
                        <small class="text-muted font-weight-bold" id="sliderMaxLabel">50.000 TL</small>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- SAĞ KOLON: ÜRÜNLER -->
    <div class="col-lg-9">

        <div class="d-flex align-items-center justify-content-between mb-4">
            <h4 class="text-gray-800 font-weight-bold mb-0">Tüm Ürünler</h4>
            <span class="badge badge-primary px-3 py-2" id="productCountBadge" style="font-size: 0.9rem;">
                Listelenen: @Model.Count() ürün
            </span>
        </div>

        <div class="row" id="productsContainer">
            @if (Model != null)
            {
                foreach (var urun in Model)
                {
                    // Artık tahmin etmiyoruz, veriden okuyoruz!
                    string kategori = urun.Kategori ?? "Diğer";

                    <div class="col-lg-4 ... product-item"
                         data-category="@kategori"
                         data-price="@urun.Fiyat">

                        <div class="card shadow-sm h-100 product-card">
                            <!-- İndirim Rozeti -->
                            <div class="badge-overlay">
                                <span class="discount-tag">@urun.Rozet</span>
                            </div>

                            <div class="card shadow-sm h-100 product-card">

                                <!-- İndirim Rozeti (Zaten Vardı) -->
                                <div class="badge-overlay">...</div>

                                <!-- YENİ EKLENEN: KALP İKONU -->
                                <!-- onclick eventi ile toggleFav fonksiyonunu çağırıyoruz -->
                                <button class="btn-fav" onclick="toggleFav(@urun.Id, this)" title="Favorilere Ekle">
                                    <i class="fas fa-heart"></i>
                                </button>

                                <!-- TIKLANABİLİR ALAN (Detay Sayfasına Gider) -->
                                <a href="@Url.Action("UrunDetay", "Home", new { id = urun.Id })" class="text-decoration-none text-dark">
                                    <div class="img-container">
                                        <img src="@urun.ResimYolu" class="product-img" alt="@urun.Ad"
                                             onerror="this.onerror=null; this.src='/Content/image/default.jpg';">
                                    </div>

                                    <div class="card-body d-flex flex-column pb-0">
                                        <h6 class="card-title font-weight-bold text-truncate" title="@urun.Ad">
                                            @urun.Ad
                                        </h6>
                                    </div>
                                </a>

                                <!-- AKSİYON ALANI (Sadece Sepet Butonu) -->
                                <div class="card-body pt-0 mt-auto">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span class="text-muted small text-decoration-line-through">@((urun.Fiyat * 1.2m).ToString("N0")) TL</span>
                                        <span class="price-tag">@urun.Fiyat.ToString("N0") TL</span>
                                    </div>

                                    <button class="btn-add-cart w-100 btn-sm" onclick="addToCart('@urun.Ad', @((int)urun.Fiyat), '@urun.ResimYolu')">
                                        <i class="fas fa-shopping-cart mr-2"></i> Sepete Ekle
                                    </button>
                                </div>
                            </div>
                        </div>

                        
                    </div>  
                }

            }
        </div>
    </div>

</div>

<!-- CSS (Tasarım) -->
<style>
    /* Sadece Index Sayfasına Özel Slider ve Filtre Ayarları */

    .carousel-item {
        /* Slider'ın yüksekliği ve geçişleri */
        transition: transform .6s ease-in-out;
    }

    /* Filtre Panelindeki Checkbox Özelleştirmeleri (Varsa) */
    .custom-control-label {
        cursor: pointer;
    }
</style>

<!-- JAVASCRIPT (Mantık) -->
<script>
    // SweetAlert
    const Toast = Swal.mixin({
        toast: true, position: 'top-end', showConfirmButton: false,
        timer: 3000, timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer);
            toast.addEventListener('mouseleave', Swal.resumeTimer);
        }
    });

    function showNotification(icon, message) {
        Toast.fire({ icon: icon, title: message });
    }

    document.addEventListener("DOMContentLoaded", function () {
        var checkboxes = document.querySelectorAll('.filter-check');
        checkboxes.forEach(function (box) {
            box.addEventListener('change', function () {
                if (!this.checked) document.getElementById('checkAll').checked = false;
                filterProducts();
            });
        });

        // Enter tuşu desteği
        document.getElementById("priceInput").addEventListener("keypress", function (event) {
            if (event.key === "Enter") manualPriceUpdate();
        });
    });

    // --- KATEGORİ ---
    function toggleAllCategories(source) {
        var checkboxes = document.querySelectorAll('.filter-check');
        checkboxes.forEach(function (box) {
            box.checked = source.checked;
        });
        filterProducts();
    }

    // --- FİYAT FONKSİYONLARI ---

    // 1. Çubuğu Kaydırınca -> Kutuyu Güncelle
    function sliderMoved() {
        var range = document.getElementById('priceRange');
        var input = document.getElementById('priceInput');
        input.value = range.value;
        filterProducts();
    }

    // 2. Kutuya Yazıp Onaylayınca -> Çubuğu ve Sınırı Güncelle
    function manualPriceUpdate() {
        var range = document.getElementById('priceRange');
        var input = document.getElementById('priceInput');
        var maxLabel = document.getElementById('sliderMaxLabel');

        var girilenDeger = parseFloat(input.value) || 0;
        var yeniLimit = Math.max(girilenDeger, 1000); // En az 1000 olsun

        // Çubuğun tavanını kullanıcının girdiği sayı yap
        range.max = yeniLimit;
        // Çubuğu o sayıya çek (En sağa)
        range.value = girilenDeger;

        // Sağ alttaki yazıyı güncelle
        maxLabel.innerText = formatMoney(yeniLimit) + " TL";

        filterProducts();
    }

    // --- FİLTRELEME ---
    function filterProducts() {
        var selectedCategories = [];
        document.querySelectorAll('.filter-check:checked').forEach(function (box) {
            selectedCategories.push(box.value);
        });

        // Fiyatı o an ÇUBUK nerede duruyorsa oradan al
        var maxPrice = parseFloat(document.getElementById('priceRange').value) || 0;

        var products = document.querySelectorAll('.product-item');
        var visibleCount = 0;

        products.forEach(function (product) {
            var productCategory = product.getAttribute('data-category');
            var productPrice = parseFloat(product.getAttribute('data-price'));

            var categoryMatch = selectedCategories.includes(productCategory);
            var priceMatch = productPrice <= maxPrice;

            if (categoryMatch && priceMatch) {
                product.style.display = 'block';
                product.style.opacity = '1';
                visibleCount++;
            } else {
                product.style.display = 'none';
            }
        });

        document.getElementById('productCountBadge').innerText = "Listelenen: " + visibleCount + " ürün";
    }

    function formatMoney(amount) {
        return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
</script>